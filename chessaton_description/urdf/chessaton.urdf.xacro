<?xml version="1.0" encoding="utf-8"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" 
    xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
    xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
    xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
    name="chessaton">

    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_include.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_gazebo.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton.ros2_control" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_hand.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/sensors/camera.urdf.xacro" />

    <!--            -->
    <!-- Parameters -->
    <!--            -->
    <!-- Name of the robot (mandatory) -->
    <xacro:arg name="name" default="chessaton"/>
    <!-- Prefix for all entities -->
    <xacro:arg name="prefix" default="chessaton_"/>
    <!-- Flag to enable default gripper -->
    <xacro:arg name="gripper" default="true" />
    <xacro:arg name="virtual_dof" default="true" />
    <!-- Flag to enable camera -->
    <xacro:arg name="use_camera" default="false" />
    <!-- ros2_control -->
    <!-- Flag to enable ros2 controllers for manipulator -->
    <xacro:arg name="ros2_control" default="true"/>
    <!-- The ros2_control plugin that should be loaded for the manipulator ('fake', 'gz', 'real' or custom) -->
    <xacro:arg name="ros2_control_plugin" default="gz"/>
    <!-- The output control command interface provided by ros2_control ('position', 'velocity', 'effort' or certain combinations 'position,velocity') -->
    <xacro:arg name="ros2_control_command_interface" default="position"/>
    <!-- The filepath to parameters of ROS 2 controllers -->
    <xacro:arg name="ros2_controller_parameters" default="$(find chessaton_description)/config/controllers_$(arg ros2_control_command_interface).yaml"/>
    <!-- Flag to preserve fixed joints and prevent lumping when generating SDF for Gazebo -->
    <xacro:arg name="gazebo_preserve_fixed_joint" default="false"/>


    <link name="world"></link>

    <joint name="virtual_joint" type="fixed">
        <origin xyz="0 0 0" rpy="0 0 0" />
        <parent link="world" />
        <child link="chessaton_link0" />
    </joint>

    <link name="chessaton_link0">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0" />
            <geometry>
              <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link0.STL" />
            </geometry>
            <material name="color_link0" />
        </visual>
    
        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link0.STL" />
          </geometry>
        </collision>

        <inertial>
            <origin xyz="-0.00088323 -3.593E-07 0.021799" rpy="0 0 0" />
            <mass value="0.35" />
            <inertia
                ixx="0.00040857"
                ixy="-1.2568E-09"
                ixz="-4.0915E-09"
                iyy="0.00041214"
                iyz="1.5948E-10"
                izz="0.00079973" />
        </inertial> 
    </link>

    <joint name="chessaton_joint1" type="revolute">
        <origin xyz="0 0 0.07184" rpy="0 0 0" />
        <parent link="chessaton_link0" />
        <child link="chessaton_link1" />
        <axis xyz="0 0 -1" />
		<dynamics damping="0.1" friction="0.1" />
        <limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="0.3" />
    </joint>

    <link name="chessaton_link1">
        <visual>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link1.STL" />
          </geometry>
          <material name="color_link1" />
        </visual>

        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link1.STL" />
          </geometry>
        </collision>

        <inertial>
            <origin xyz="-2.4829E-06 1.8095E-11 0.025578" rpy="0 0 0" />
            <mass value="0.116" />
            <inertia
              ixx="5.4663E-05"
              ixy="-1.3316E-07"
              ixz="3.3526E-14"
              iyy="4.2517E-05"
              iyz="-8.2983E-14"
              izz="8.9443E-05" />
        </inertial>
    </link>

	<joint name="chessaton_joint2" type="revolute">
		<origin xyz="0 1.29770906784333E-05 0.0305688591051693" rpy="0 0 0" />
		<parent link="chessaton_link1" />
		<child link="chessaton_link2" />
		<axis xyz="0 1 0" />
		<dynamics damping="0.1" friction="0.1" />
		<limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="0.3" />
	</joint>

    <link name="chessaton_link2">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0" />
            <geometry>
              <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link2.STL" />
            </geometry>
            <material name="color_link2" />
        </visual>

        <inertial>
            <origin xyz="-2.3338E-06 4.5723E-05 0.093503" rpy="0 0 0" />
            <mass value="0.071" />
            <inertia
              ixx="6.1321E-05"
              ixy="-6.9447E-10"
              ixz="4.4166E-12"
              iyy="3.639E-05"
              iyz="-4.4751E-13"
              izz="3.1036E-05" />
        </inertial>

        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link2.STL" />
          </geometry>
        </collision>
    </link>

	<joint name="chessaton_joint3" type="revolute">
	  	<origin xyz="0 0.025345720651074 0.187006906655083" rpy="0 0 0" />
	  	<parent link="chessaton_link2" />
	  	<child link="chessaton_link3" />
	  	<axis xyz="0 1 0" />
	  	<dynamics damping="0.1" friction="0.1" />
	  	<limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="0.3" />
	</joint>

	<link name="chessaton_link3">
		<visual>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link3.STL" />
		  </geometry>
		  <material name="color_link3" />
		</visual>

		<collision>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link3.STL" />
		  </geometry>
		</collision>

		<inertial>
            <origin xyz="0.041523 -0.024547 -0.0018439" rpy="0 0 0" />
            <mass value="0.01" />
            <inertia
              ixx="2.455E-05"
              ixy="-7.247E-09"
              ixz="-2.7697E-07"
              iyy="3.4978E-05"
              iyz="4.524E-07"
              izz="5.1335E-05" />
        </inertial>
	</link>

	<joint name="chessaton_joint4" type="revolute">
	    <origin xyz="0.157407990853242 0.00282292319687479 -0.000108863252950619" rpy="0 0 0" />
	    <parent link="chessaton_link3" />
	    <child link="chessaton_link4" />
	    <axis xyz="0 1 0" />
		<dynamics damping="0.1" friction="0.1" />
	    <limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="0.3" />
	</joint>

	<link name="chessaton_link4">
		<visual>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link4.STL" />
		  </geometry>
		  <material name="color_link4" />
		</visual>

		<collision>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link4.STL" />
		  </geometry>
		</collision>

        <inertial>
            <origin xyz="0.0024706 -0.026918 -0.010053" rpy="0 0 0" />
            <mass value="0.0465" />
            <inertia
              ixx="1.4407E-05"
              ixy="-4.5338E-07"
              ixz="-1.5306E-09"
              iyy="1.0461E-05"
              iyz="-4.0782E-09"
              izz="7.7123E-06" />
        </inertial>
	</link>

	<joint name="gripper_joint" type="fixed">
	  <origin xyz="0.070608507146197 -0.0126359232516508 -0.0087074752469517" rpy="0 0 0" />
	  <parent link="chessaton_link4" />
	  <child link="chessaton_gripper" />
	  <axis xyz="0 0 0" />
	</joint>

    <xacro:chessaton_hand
        virtual_dof="$(arg virtual_dof)"
    />

    <xacro:if value="$(arg use_camera)">
        <xacro:sensor_camera /> 
    </xacro:if>

      <!-- Transmission macro -->
  <!-- <xacro:macro name="SimpleTransmissionPosition" params="joint n">
    <transmission name="tran${n}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${joint}">
        <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
      </joint>
      <actuator name="motor${n}">
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro> -->

  <!-- Transmission macro -->
  <!-- <xacro:macro name="SimpleTransmissionEffort" params="joint n">
    <transmission name="tran${n}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${joint}">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="motor${n}">
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro> -->

  <!-- <xacro:SimpleTransmissionEffort n="1" joint="chessaton_joint1" />

  <xacro:SimpleTransmissionEffort n="2" joint="chessaton_joint2" />

  <xacro:SimpleTransmissionEffort n="3" joint="chessaton_joint3" />

  <xacro:SimpleTransmissionEffort n="4" joint="chessaton_joint4" />

  <xacro:SimpleTransmissionEffort n="5" joint="left_finger_joint" />

  <xacro:SimpleTransmissionEffort n="6" joint="right_finger_joint" /> -->

    <xacro:gz_ros2_control
        ros2_controller_parameters="$(arg ros2_controller_parameters)"
    />

    <xacro:mein_ros2_control
        ros2_control="$(arg ros2_control)"
        prefix="$(arg prefix)" 
        ros2_control_plugin="$(arg ros2_control_plugin)"
        ros2_control_command_interface="$(arg ros2_control_command_interface)"
        ros2_controller_parameters="$(arg ros2_controller_parameters)"
    />

</robot>