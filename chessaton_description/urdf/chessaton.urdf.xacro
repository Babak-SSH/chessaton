<?xml version="1.0" encoding="utf-8"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" 
    xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
    xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
    xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
    name="chessaton">

    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_include.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_gazebo.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton.ros2_control" />
    <xacro:include filename="$(find chessaton_description)/urdf/chessaton_hand.xacro" />
    <xacro:include filename="$(find chessaton_description)/urdf/sensors/camera.urdf.xacro" />

    <!--            -->
    <!-- Parameters -->
    <!--            -->
    <!-- Name of the robot (mandatory) -->
    <xacro:arg name="name" default="chessaton"/>
    <!-- Prefix for all entities -->
    <xacro:arg name="prefix" default="chessaton_"/>
    <!-- Flag to enable default gripper -->
    <xacro:arg name="gripper" default="true" />
    <xacro:arg name="virtual_dof" default="true" />
    <!-- Flag to enable camera -->
    <xacro:arg name="use_camera" default="false" />
    <!-- ros2_control -->
    <!-- Flag to enable ros2 controllers for manipulator -->
    <xacro:arg name="ros2_control" default="true"/>
    <!-- The ros2_control plugin that should be loaded for the manipulator ('fake', 'gz', 'real' or custom) -->
    <xacro:arg name="ros2_control_plugin" default="gz"/>
    <!-- The output control command interface provided by ros2_control ('position', 'velocity', 'effort' or certain combinations 'position,velocity') -->
    <xacro:arg name="ros2_control_command_interface" default="position"/>
    <!-- The filepath to parameters of ROS 2 controllers -->
    <xacro:arg name="ros2_controller_parameters" default="$(find chessaton_description)/config/controllers_$(arg ros2_control_command_interface).yaml"/>
    <!-- Flag to preserve fixed joints and prevent lumping when generating SDF for Gazebo -->
    <xacro:arg name="gazebo_preserve_fixed_joint" default="false"/>


    <link name="world"></link>

    <joint name="virtual_joint" type="fixed">
        <origin xyz="0 0 0" rpy="0 0 0" />
        <parent link="world" />
        <child link="chessaton_link0" />
    </joint>

    <link name="chessaton_link0">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0" />
            <geometry>
              <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link0.STL" />
            </geometry>
            <material name="color_link0" />
        </visual>
    
        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link0.STL" />
          </geometry>
        </collision>

        <inertial>
            <origin xyz="-0.00073528 0.0040282 0.031188" rpy="0 0 0" />
            <mass value="0.094842" />
            <inertia
              ixx="3.0463E-05"
              ixy="-6.3087E-09"
              ixz="4.236E-07"
              iyy="4.8143E-05"
              iyz="-8.1925E-08"
              izz="5.1511E-05" />
        </inertial> 
    </link>

    <joint name="chessaton_joint1" type="revolute">
        <origin xyz="0.00015368 0.01229 0.07705" rpy="0 0 0" />
        <parent link="chessaton_link0" />
        <child link="chessaton_link1" />
        <axis xyz="0 0 -1" />
		<dynamics damping="1.0" friction="1.0" />
        <limit lower="${-pi}" upper="${pi}" effort="0" velocity="5" />
    </joint>

    <link name="chessaton_link1">
        <visual>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link1.STL" />
          </geometry>
          <material name="color_link1" />
        </visual>

        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link1.STL" />
          </geometry>
        </collision>

        <inertial>
            <origin xyz="0.012256 -0.0045169 0.011915" rpy="0 0 0" />
            <mass value="0.047535" />
            <inertia
              ixx="8.1555E-06"
              ixy="-8.4986E-08"
              ixz="1.6429E-09"
              iyy="1.0365E-05"
              iyz="4.236E-07"
              izz="1.4637E-05" />
        </inertial>
    </link>

	<joint name="chessaton_joint2" type="revolute">
		<origin xyz="0.022504 0.022833 0.013792" rpy="0 0 0" />
		<parent link="chessaton_link1" />
		<child link="chessaton_link2" />
		<axis xyz="0 -1 0" />
		<dynamics damping="1.0" friction="1.0" />
		<limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="5" />
	</joint>

    <link name="chessaton_link2">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0" />
            <geometry>
              <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link2.STL" />
            </geometry>
            <material name="color_link2" />
        </visual>

        <inertial>
            <origin xyz="1.1343E-09 -0.02475 0.101" rpy="0 0 0" />
            <mass value="0.077067" />
            <inertia
              ixx="7.2952E-05"
              ixy="4.5829E-12"
              ixz="1.1087E-14"
              iyy="4.7593E-05"
              iyz="3.7988E-20"
              izz="3.1748E-05" />
        </inertial>

        <collision>
          <origin xyz="0 0 0" rpy="0 0 0" />
          <geometry>
            <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link2.STL" />
          </geometry>
        </collision>
    </link>

	<joint name="chessaton_joint3" type="revolute">
	  	<origin xyz="0 0 0.202" rpy="0 0 0" />
	  	<parent link="chessaton_link2" />
	  	<child link="chessaton_link3" />
	  	<axis xyz="0 -1 0" />
	  	<dynamics damping="1.0" friction="1.0" />
	  	<limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="6" />
	</joint>

	<link name="chessaton_link3">
		<visual>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link3.STL" />
		  </geometry>
		  <material name="color_link3" />
		</visual>

		<collision>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link3.STL" />
		  </geometry>
		</collision>

		<inertial>
            <origin xyz="0.071008 -0.024827 -0.00025021" rpy="0 0 0" />
            <mass value="0.10766" />
            <inertia
              ixx="2.5545E-05"
              ixy="8.4872E-08"
              ixz="-3.21E-07"
              iyy="4.8596E-05"
              iyz="4.236E-07"
              izz="6.5475E-05" />
        </inertial>
	</link>

	<joint name="chessaton_joint4" type="revolute">
	    <origin xyz="0.1985 0.0019174 0.0019578" rpy="0 0 0" />
	    <parent link="chessaton_link3" />
	    <child link="chessaton_link4" />
	    <axis xyz="0 -1 0" />
		<dynamics damping="1.0" friction="1.0" />
	    <limit lower="${-pi/2}" upper="${pi/2}" effort="0" velocity="6" />
	</joint>

	<link name="chessaton_link4">
		<visual>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link4.STL" />
		  </geometry>
		  <material name="color_link4" />
		</visual>

		<collision>
		  <origin xyz="0 0 0" rpy="0 0 0" />
		  <geometry>
		    <mesh filename="file://$(find chessaton_description)/meshes/chessaton_link4.STL" />
		  </geometry>
		</collision>

        <inertial>
            <origin xyz="0.0016488 -0.027436 -0.0097099" rpy="0 0 0" />
            <mass value="0.0466425419935174" />
            <inertia
              ixx="1.458E-05"
              ixy="-4.2359E-07"
              ixz="-1.6429E-09"
              iyy="1.0335E-05"
              iyz="-8.4986E-08"
              izz="8.1259E-06" />
        </inertial>
	</link>

	<joint name="gripper_joint" type="fixed">
	  <origin xyz="0.072842 -0.034194 -0.0048547" rpy="0 0 0" />
	  <parent link="chessaton_link4" />
	  <child link="chessaton_gripper" />
	  <axis xyz="0 0 0" />
	</joint>

    <xacro:chessaton_hand
        virtual_dof="$(arg virtual_dof)"
    />

    <xacro:if value="$(arg use_camera)">
        <xacro:sensor_camera /> 
    </xacro:if>

      <!-- Transmission macro -->
  <!-- <xacro:macro name="SimpleTransmissionPosition" params="joint n">
    <transmission name="tran${n}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${joint}">
        <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
      </joint>
      <actuator name="motor${n}">
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro> -->

  <!-- Transmission macro -->
  <!-- <xacro:macro name="SimpleTransmissionEffort" params="joint n">
    <transmission name="tran${n}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${joint}">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="motor${n}">
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro> -->

  <!-- <xacro:SimpleTransmissionEffort n="1" joint="chessaton_joint1" />

  <xacro:SimpleTransmissionEffort n="2" joint="chessaton_joint2" />

  <xacro:SimpleTransmissionEffort n="3" joint="chessaton_joint3" />

  <xacro:SimpleTransmissionEffort n="4" joint="chessaton_joint4" />

  <xacro:SimpleTransmissionEffort n="5" joint="left_finger_joint" />

  <xacro:SimpleTransmissionEffort n="6" joint="right_finger_joint" /> -->

    <xacro:gz_ros2_control
        ros2_controller_parameters="$(arg ros2_controller_parameters)"
    />

    <xacro:mein_ros2_control
        ros2_control="$(arg ros2_control)"
        prefix="$(arg prefix)" 
        ros2_control_plugin="$(arg ros2_control_plugin)"
        ros2_control_command_interface="$(arg ros2_control_command_interface)"
        ros2_controller_parameters="$(arg ros2_controller_parameters)"
    />

</robot>